<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–æ–Ω—Ç–µ–Ω—Ç –ó–∞–≤–æ–¥ ‚Äî –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</title>
    <style>
        :root { --bg: #0d0d0d; --card: #1a1a1a; --accent: #00ff88; --text: #ffffff; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .container { width: 100%; max-width: 1000px; }
        
        /* –®–ê–ü–ö–ê */
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #333; padding-bottom: 15px; margin-bottom: 30px; }
        h1 { color: var(--accent); margin: 0; font-size: 28px; letter-spacing: 1px; text-transform: uppercase; font-weight: 900; }
        .btn-reset { background: #ff4444; border: none; color: white; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; }

        /* –≠–ö–†–ê–ù –í–•–û–î–ê */
        #auth-screen { text-align: center; margin-top: 15vh; }
        .auth-card { background: var(--card); padding: 50px; border-radius: 30px; border: 1px solid #333; display: inline-block; box-shadow: 0 20px 50px rgba(0,0,0,0.7); }
        input { background: #222; border: 2px solid #444; color: white; padding: 20px; border-radius: 15px; width: 350px; margin-bottom: 25px; font-size: 18px; outline: none; text-align: center; }
        input:focus { border-color: var(--accent); }
        .btn-login { background: var(--accent); color: black; border: none; padding: 20px 40px; border-radius: 15px; font-weight: 900; cursor: pointer; width: 100%; font-size: 18px; text-transform: uppercase; }

        /* –î–≠–®–ë–û–†–î */
        #dashboard { display: none; width: 100%; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 25px; margin-bottom: 50px; }
        .card { background: var(--card); border-radius: 25px; padding: 30px; border: 1px solid #333; transition: 0.3s; }
        .card:hover { border-color: var(--accent); transform: translateY(-5px); }
        .platform { font-size: 12px; color: var(--accent); text-transform: uppercase; font-weight: 900; margin-bottom: 10px; display: block; opacity: 0.8; }
        .username { font-size: 24px; font-weight: 800; margin-bottom: 20px; display: block; }
        .stat-item { display: flex; justify-content: space-between; align-items: center; background: #252525; padding: 18px; border-radius: 15px; margin-bottom: 12px; }
        .stat-label { color: #888; font-size: 14px; }
        .stat-value { font-size: 22px; font-weight: 900; color: var(--accent); }

        /* –ú–û–ù–ò–¢–û–† */
        .log-panel { background: #000; border: 1px dashed #444; border-radius: 15px; padding: 20px; width: 100%; margin-top: 40px; font-family: monospace; }
        .log-header { color: #888; font-size: 12px; text-transform: uppercase; margin-bottom: 15px; display: block; border-bottom: 1px solid #222; padding-bottom: 10px; }
        pre { background: #111; padding: 15px; border-radius: 10px; overflow-x: auto; color: #00ff88; font-size: 12px; line-height: 1.5; white-space: pre-wrap; }
        .loading { text-align: center; margin-top: 100px; font-size: 20px; color: var(--accent); font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <div id="auth-screen">
        <div class="auth-card">
            <h1>üè≠ –ö–û–ù–¢–ï–ù–¢ –ó–ê–í–û–î</h1>
            <p style="color:#666; margin-bottom:20px;">–î–û–°–¢–£–ü –í –¶–ï–•</p>
            <input type="password" id="key-input" placeholder="–í–°–¢–ê–í–¨ –ö–õ–Æ–ß BLT_...">
            <button class="btn-login" onclick="startFactory()">–ó–ê–ü–£–°–¢–ò–¢–¨</button>
        </div>
    </div>

    <div id="dashboard">
        <div class="header">
            <h1>üè≠ –¶–ï–• –ê–ù–ê–õ–ò–¢–ò–ö–ò</h1>
            <button class="btn-reset" onclick="resetFactory()">–í–´–•–û–î</button>
        </div>
        <div id="loader" class="loading">‚öôÔ∏è –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï –ö –°–ò–°–¢–ï–ú–ï...</div>
        <div id="stats-grid" class="grid"></div>

        <div class="log-panel">
            <span class="log-header">üìü –ú–û–ù–ò–¢–û–† –ú–ê–°–°–ò–í–ê (DEBUG LOG)</span>
            <pre id="raw-log">–û–∂–∏–¥–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö...</pre>
        </div>
    </div>
</div>

<script>
    // URL –¥–ª—è —Ä–∞–±–æ—Ç—ã –≤ —Ä–µ–∂–∏–º–µ Active (Production)
    const webhookUrl = "https://nikolaenko-ds.ru/webhook/content-zavod";

    window.onload = () => {
        const savedKey = localStorage.getItem('zavod_key');
        if (savedKey) showStats(savedKey);
    };

    function startFactory() {
        const key = document.getElementById('key-input').value.trim();
        if (key.startsWith('blt_')) {
            localStorage.setItem('zavod_key', key);
            showStats(key);
        } else { alert("–ö–ª—é—á –¥–æ–ª–∂–µ–Ω –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å blt_"); }
    }

    function resetFactory() {
        localStorage.removeItem('zavod_key');
        location.reload();
    }

    async function showStats(key) {
        document.getElementById('auth-screen').style.display = 'none';
        document.getElementById('dashboard').style.display = 'block';
        const grid = document.getElementById('stats-grid');
        const loader = document.getElementById('loader');
        const logDisplay = document.getElementById('raw-log');

        try {
            const response = await fetch(`${webhookUrl}?key=${encodeURIComponent(key)}`, { 
                method: 'GET',
                mode: 'cors',
                headers: {
                    'Accept': 'application/json'
                }
            });

            if (!response.ok) {
                throw new Error(`–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${response.status}`);
            }

            const raw = await response.text();
            if (!raw || !raw.trim()) {
                throw new Error("–ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –æ—Ç webhook (body –ø—É—Å—Ç–æ–π). –ü—Ä–æ–≤–µ—Ä—å Respond to Webhook / response mode –≤ n8n.");
            }

            let data;
            try {
                data = JSON.parse(raw);
            } catch (e) {
                // –ø–æ–∫–∞–∂–µ–º —Å—ã—Ä–æ–π –æ—Ç–≤–µ—Ç, —á—Ç–æ–±—ã –ø–æ–Ω—è—Ç—å —á—Ç–æ –≤–µ—Ä–Ω—É–ª —Å–µ—Ä–≤–µ—Ä (HTML, —Ç–µ–∫—Å—Ç –æ—à–∏–±–∫–∏, –æ–±—Ä–µ–∑–∞–Ω–Ω—ã–π JSON –∏ —Ç.–ø.)
                logDisplay.innerText = raw;
                throw new Error("–û—Ç–≤–µ—Ç –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –≤–∞–ª–∏–¥–Ω—ã–º JSON (–≤–æ–∑–º–æ–∂–µ–Ω CORS/–ø—Ä–æ–∫—Å–∏/–æ—à–∏–±–∫–∞ –Ω–æ–¥—ã).");
            }

            logDisplay.innerText = JSON.stringify(data, null, 2);

            if (data.message && !Array.isArray(data)) {
                loader.innerHTML = "‚ùå n8n –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –Ω–∞ –æ—Ç–≤–µ—Ç (Response Mode).";
                return;
            }

            loader.style.display = 'none';
            grid.innerHTML = data.map(acc => `
                <div class="card">
                    <span class="platform">${acc.platform || 'Social'}</span>
                    <span class="username">${acc.name || acc.username || '–ê–∫–∫–∞—É–Ω—Ç'}</span>

                    <div style="display:flex; gap:10px; margin-bottom:18px;">
                        ${
                            acc.profile_url
                                ? `<a href="${acc.profile_url}" target="_blank" rel="noopener noreferrer"
                                    style="background:#00ff88;color:#000;padding:10px 14px;border-radius:12px;
                                           font-weight:900;text-decoration:none;display:inline-block;">
                                    –û–¢–ö–†–´–¢–¨
                                   </a>`
                                : `<span style="background:#333;color:#999;padding:10px 14px;border-radius:12px;
                                               font-weight:900;display:inline-block;">
                                    –ù–ï–¢ –°–°–´–õ–ö–ò
                                   </span>`
                        }
                    </div>

                    <div class="stat-item">
                        <span class="stat-label">–í–ò–î–ï–û</span>
                        <span class="stat-value">${acc.total_posts || 0}</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">–ü–†–û–°–ú–û–¢–†–´</span>
                        <span class="stat-value" style="color:#00d4ff;">${(acc.total_views || 0).toLocaleString()}</span>
                    </div>
                </div>
            `).join('');

        } catch (err) {
            loader.innerHTML = "‚ùå –û–®–ò–ë–ö–ê –°–í–Ø–ó–ò (FAILED TO FETCH)";
            logDisplay.innerText = "–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: " + err.message + 
                "\n\n–ß–µ–∫-–ª–∏—Å—Ç —Ä–µ—à–µ–Ω–∏—è:\n1) –í–∫–ª—é—á–∏ —Ç—É–º–±–ª–µ—Ä ACTIVE —É workflow –≤ n8n.\n2) –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ Webhook –¥–æ—Å—Ç—É–ø–µ–Ω –ò–ú–ï–ù–ù–û –ø–æ HTTPS –∏ –ø—É–±–ª–∏—á–Ω–æ (GitHub Pages –Ω–µ –º–æ–∂–µ—Ç —Ö–æ–¥–∏—Ç—å –Ω–∞ http/localhost ‚Äî –±—Ä–∞—É–∑–µ—Ä –±–ª–æ–∫–∏—Ä—É–µ—Ç Mixed Content).\n3) –í Webhook Node –≤–∫–ª—é—á–∏ CORS –∏ —Ä–∞–∑—Ä–µ—à–∏ –∑–∞–≥–æ–ª–æ–≤–æ–∫ blotato-api-key (Access-Control-Allow-Headers).\n4) –£–±–µ–¥–∏—Å—å, —á—Ç–æ n8n —Ä–µ–∞–ª—å–Ω–æ –æ—Ç–≤–µ—á–∞–µ—Ç JSON: Response Mode = \"Last Node\" –ò–õ–ò –∏—Å–ø–æ–ª—å–∑—É–π \"Respond to Webhook\" node.\n5) –ï—Å–ª–∏ –≤–∏–¥–∏—à—å preflight OPTIONS ‚Äî –¥–æ–±–∞–≤—å –º–µ—Ç–æ–¥ OPTIONS –≤ Webhook (–∏–ª–∏ –≤–∫–ª—é—á–∏ \"Respond to OPTIONS request\").";
        }
    }
</script>
</body>
</html>
