<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Контент Завод — Дашборд аккаунтов</title>

  <!-- Typography -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg: #000000;
      --text: #ffffff;
      --muted: #999999;
      --accent: #ccff00;
      --accent-dark: #99cc00;
      --cyan: #00ffff;
      --pink: #ff00ff;
      --green: #00ff00;
      --border: #333333;
      --card-bg: #0a0a0a;
    }

    *{ box-sizing: border-box; }
    html, body{ height: 100%; }
    body{
      margin: 0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--text);
      background: var(--bg);
      overflow-x: hidden;
    }

    a{ color: inherit; text-decoration: none; }

    .container{
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px 18px 60px;
    }

    /* ====== TOPBAR ====== */
    .topbar{
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 40px;
      padding: 0 18px;
      max-width: 1200px;
      margin-left: auto;
      margin-right: auto;
    }

    .brand{
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo{
      width: 40px;
      height: 40px;
      background: var(--accent);
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 900;
      color: var(--bg);
      font-size: 20px;
    }

    .brand-text{
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .brand h1{
      margin: 0;
      font-size: 14px;
      font-weight: 900;
      letter-spacing: 1px;
      text-transform: uppercase;
    }

    .brand .sub{
      font-size: 10px;
      color: var(--muted);
      letter-spacing: 0.5px;
      text-transform: uppercase;
    }

    .status{
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--accent);
      font-weight: 700;
    }

    .status-dot{
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--accent);
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    /* ====== HERO ====== */
    .hero{
      margin-bottom: 40px;
    }

    .hero h2{
      margin: 0 0 16px;
      font-size: 56px;
      line-height: 1.1;
      font-weight: 900;
      text-transform: uppercase;
      font-style: italic;
      letter-spacing: -1px;
    }

    .hero h2 .accent{
      color: var(--accent);
    }

    .hero p{
      margin: 0 0 24px;
      color: var(--muted);
      font-weight: 400;
      line-height: 1.6;
      max-width: 60ch;
      font-size: 14px;
    }

    .hero-inner{
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
      align-items: start;
    }

    @media (max-width: 920px){
      .hero-inner{ grid-template-columns: 1fr; }
      .hero h2{ font-size: 36px; }
    }

    /* ====== CONTROLS ====== */
    .controls{
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 12px;
    }

    .field{
      display: flex;
      align-items: center;
      gap: 10px;
      flex: 1 1 300px;
      min-width: 280px;
      padding: 12px 14px;
      border-radius: 4px;
      background: var(--card-bg);
      border: 1px solid var(--border);
      color: var(--text);
    }

    .field input{
      width: 100%;
      outline: none;
      border: none;
      background: transparent;
      color: var(--text);
      font-size: 12px;
      font-weight: 600;
      letter-spacing: 0.5px;
      text-transform: uppercase;
    }

    .field input::placeholder{
      color: var(--muted);
      font-weight: 600;
      text-transform: uppercase;
    }

    .btn{
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px 18px;
      border-radius: 4px;
      border: 1px solid transparent;
      background: transparent;
      color: var(--text);
      font-weight: 900;
      font-size: 12px;
      letter-spacing: 0.5px;
      cursor: pointer;
      transition: all 0.12s ease;
      user-select: none;
      text-transform: uppercase;
    }

    .btn:hover{
      transform: translateY(-2px);
    }

    .btn:active{
      transform: translateY(0px) scale(0.98);
    }

    .btn.primary{
      background: var(--accent);
      color: var(--bg);
      border-color: var(--accent);
      font-weight: 900;
    }

    .btn.primary:hover{
      background: var(--accent-dark);
      border-color: var(--accent-dark);
    }

    .btn.secondary{
      border: 1px solid var(--border);
      color: var(--text);
    }

    .btn.secondary:hover{
      border-color: var(--accent);
      color: var(--accent);
    }

    .btn.danger{
      border: 1px solid #ff4444;
      color: #ff4444;
    }

    .btn.danger:hover{
      background: rgba(255, 68, 68, 0.1);
    }

    .hint{
      font-size: 11px;
      color: var(--muted);
      margin-top: 8px;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    .hint a{
      color: var(--accent);
      text-decoration: underline;
    }

    /* ====== STATS ====== */
    .stats{
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }

    @media (max-width: 920px){
      .stats{ grid-template-columns: repeat(4, 1fr); }
    }

    @media (max-width: 680px){
      .stats{ grid-template-columns: repeat(2, 1fr); }
    }

    .stat-card{
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 16px;
      background: var(--card-bg);
      text-align: center;
    }

    .stat-label{
      font-size: 10px;
      color: var(--muted);
      font-weight: 700;
      letter-spacing: 0.5px;
      text-transform: uppercase;
      margin-bottom: 8px;
    }

    .stat-value{
      font-size: 32px;
      font-weight: 900;
      color: var(--accent);
    }

    .stat-card.instagram .stat-value{ color: var(--pink); }
    .stat-card.tiktok .stat-value{ color: var(--cyan); }
    .stat-card.youtube .stat-value{ color: var(--green); }

    /* ====== FILTERS ====== */
    .filters{
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin: 32px 0 20px;
      align-items: center;
      border-bottom: 1px solid var(--border);
      padding-bottom: 16px;
    }

    .chip{
      padding: 8px 12px;
      border-radius: 4px;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--muted);
      font-weight: 700;
      font-size: 11px;
      letter-spacing: 0.5px;
      cursor: pointer;
      user-select: none;
      transition: all 0.12s ease;
      text-transform: uppercase;
    }

    .chip:hover{
      border-color: var(--accent);
      color: var(--accent);
    }

    .chip.active{
      background: var(--accent);
      color: var(--bg);
      border-color: var(--accent);
    }

    .search-field{
      margin-left: auto;
      flex: 0 1 280px;
    }

    /* ====== GRID ====== */
    .grid{
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      margin-top: 20px;
    }

    @media (max-width: 1000px){ .grid{ grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 680px){ .grid{ grid-template-columns: 1fr; } }

    .card{
      border: 1px solid var(--border);
      border-radius: 4px;
      background: var(--card-bg);
      padding: 16px;
      position: relative;
      overflow: hidden;
      min-height: 160px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      transition: all 0.12s ease;
    }

    .card:hover{
      border-color: var(--accent);
      background: rgba(204, 255, 0, 0.02);
    }

    .card.skeleton{
      animation: skeleton-loading 1s infinite;
    }

    @keyframes skeleton-loading {
      0%, 100% { opacity: 0.6; }
      50% { opacity: 1; }
    }

    .tag{
      display: inline-block;
      font-size: 9px;
      font-weight: 900;
      letter-spacing: 0.5px;
      text-transform: uppercase;
      padding: 4px 8px;
      border-radius: 3px;
      background: rgba(204, 255, 0, 0.1);
      color: var(--accent);
      width: fit-content;
    }

    .tag.instagram{
      background: rgba(255, 0, 255, 0.1);
      color: var(--pink);
    }

    .tag.tiktok{
      background: rgba(0, 255, 255, 0.1);
      color: var(--cyan);
    }

    .tag.youtube{
      background: rgba(0, 255, 0, 0.1);
      color: var(--green);
    }

    .name{
      margin: 0;
      font-size: 16px;
      font-weight: 900;
      line-height: 1.2;
      text-transform: uppercase;
    }

    .meta{
      display: flex;
      flex-direction: column;
      gap: 4px;
      flex: 1;
    }

    .badge{
      font-size: 11px;
      color: var(--muted);
      font-weight: 600;
      letter-spacing: 0.3px;
      text-transform: uppercase;
    }

    .actions{
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: auto;
    }

    .linkbtn{
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 8px 10px;
      border-radius: 3px;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--text);
      font-size: 10px;
      font-weight: 700;
      letter-spacing: 0.3px;
      cursor: pointer;
      transition: all 0.12s ease;
      text-transform: uppercase;
      text-decoration: none;
    }

    .linkbtn:hover{
      border-color: var(--accent);
      color: var(--accent);
    }

    .linkbtn.open{
      border-color: var(--green);
      color: var(--green);
    }

    .linkbtn.open:hover{
      background: rgba(0, 255, 0, 0.1);
    }

    .linkbtn.search{
      border-color: var(--cyan);
      color: var(--cyan);
    }

    .linkbtn.search:hover{
      background: rgba(0, 255, 255, 0.1);
    }

    .linkbtn.none{
      border-color: #666666;
      color: #666666;
      cursor: default;
    }

    /* ====== EMPTY STATE ====== */
    .empty{
      text-align: center;
      padding: 40px 20px;
      color: var(--muted);
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* ====== DEBUG ====== */
    .debug{
      margin-top: 20px;
      padding: 16px;
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: #ff4444;
      font-size: 12px;
      overflow-x: auto;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    /* ====== FOOTER ====== */
    .footer{
      margin-top: 40px;
      padding-top: 20px;
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 16px;
      font-size: 11px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    .footer a{
      color: var(--accent);
      text-decoration: underline;
    }

    .footer a:hover{
      color: var(--accent-dark);
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="brand">
      <div class="logo">◆</div>
      <div class="brand-text">
        <h1>Контент Завод</h1>
        <div class="sub">Year 2028 • AI Factory</div>
      </div>
    </div>
    <div class="status">
      <div class="status-dot"></div>
      <span id="statusText">System Ready</span>
    </div>
  </div>

  <div class="container">
    <div class="hero">
      <h2>Ваши аккаунты <span class="accent">в одном месте</span></h2>
      <p>Подключите API‑ключ, чтобы мгновенно увидеть все ваши ресурсы и управлять ими.</p>

      <div class="hero-inner">
        <div>
          <div class="controls">
            <div class="field">
              <input id="apiKey" type="password" placeholder="Введите ваш API ключ..." autocomplete="off" />
            </div>
            <button class="btn primary" id="btnLoad">Загрузить</button>
            <button class="btn secondary" id="btnSave">Сохранить</button>
            <button class="btn danger" id="btnLogout">Выйти</button>
          </div>

          <div class="hint">
            Ключ хранится только в вашем браузере (localStorage). Если это публичная страница — не делитесь ключом.
          </div>
        </div>

        <div class="stats">
          <div class="stat-card">
            <div class="stat-label">Всего</div>
            <div class="stat-value" id="mTotal">—</div>
          </div>
          <div class="stat-card instagram">
            <div class="stat-label">Instagram</div>
            <div class="stat-value" id="mInsta">—</div>
          </div>
          <div class="stat-card tiktok">
            <div class="stat-label">TikTok</div>
            <div class="stat-value" id="mTiktok">—</div>
          </div>
          <div class="stat-card youtube">
            <div class="stat-label">YouTube</div>
            <div class="stat-value" id="mYoutube">—</div>
          </div>
        </div>
      </div>
    </div>

    <div class="filters">
      <div class="chip active" data-filter="all">Все</div>
      <div class="chip" data-filter="instagram">Instagram</div>
      <div class="chip" data-filter="tiktok">TikTok</div>
      <div class="chip" data-filter="youtube">YouTube</div>

      <div class="field search-field">
        <input id="search" type="text" placeholder="Поиск аккаунта..." />
      </div>
    </div>

    <div id="grid" class="grid"></div>

    <div id="empty" class="empty" style="display:none;">
      Ничего не найдено. Проверьте фильтр или строку поиска.
    </div>

    <pre id="debug" class="debug" style="display:none;"></pre>

    <div class="footer">
      <div>Webhook: <span id="wh"></span></div>
      <div>
        <a href="https://my.blotato.com/api-dashboard" target="_blank" rel="noopener noreferrer">API Dashboard</a>
        <span style="opacity:.35;"> • </span>
        <a href="#" id="copyWebhook">Скопировать webhook</a>
      </div>
    </div>
  </div>

  <script>
    // ====== CONFIG ======
    const webhookUrl = "https://nikolaenko-ds.ru/webhook/content-zavod";

    // ====== STATE ======
    let allAccounts = [];
    let activeFilter = "all";

    // ====== DOM ======
    const elKey = document.getElementById("apiKey");
    const elGrid = document.getElementById("grid");
    const elDebug = document.getElementById("debug");
    const elEmpty = document.getElementById("empty");
    const elSearch = document.getElementById("search");
    const elStatus = document.getElementById("statusText");

    const mTotal = document.getElementById("mTotal");
    const mInsta = document.getElementById("mInsta");
    const mTiktok = document.getElementById("mTiktok");
    const mYoutube = document.getElementById("mYoutube");

    document.getElementById("wh").textContent = webhookUrl;

    // Keyboard shortcut: Cmd/Ctrl + K focuses the key input
    window.addEventListener("keydown", (e) => {
      if ((e.metaKey || e.ctrlKey) && e.key.toLowerCase() === "k") {
        e.preventDefault();
        elKey.focus();
      }
    });

    // ====== localStorage ======
    const LS_KEY = "blotato_key";
    const YT_LINKS_KEY = "yt_links_v1";

    function loadYtLinks(){
      try{ return JSON.parse(localStorage.getItem(YT_LINKS_KEY) || "{}") || {}; }catch(e){ return {}; }
    }
    function saveYtLinks(map){
      localStorage.setItem(YT_LINKS_KEY, JSON.stringify(map || {}));
    }
    function getYtLink(accountId){
      const m = loadYtLinks();
      return (m[accountId] || "").trim() || null;
    }
    function setYtLink(accountId, url){
      const m = loadYtLinks();
      if (url) m[accountId] = url;
      else delete m[accountId];
      saveYtLinks(m);
    }

    function getSavedKey() { return (localStorage.getItem(LS_KEY) || "").trim(); }
    function saveKey() { localStorage.setItem(LS_KEY, (elKey.value || "").trim()); setStatus(true, "Ключ сохранён"); }
    function logout() {
      localStorage.removeItem(LS_KEY);
      elKey.value = "";
      allAccounts = [];
      render();
      setStatus(null, "Ключ удалён");
      elDebug.style.display = "none";
    }

    // ====== helpers ======
    function setStatus(ok, text){
      if (ok === true) {
        elStatus.textContent = "SYSTEM READY";
        elStatus.style.color = "var(--accent)";
      } else if (ok === false) {
        elStatus.textContent = "ERROR";
        elStatus.style.color = "#ff4444";
      } else {
        elStatus.textContent = text || "LOADING";
        elStatus.style.color = "var(--muted)";
      }
    }

    function normPlatform(p){
      p = (p || "").toLowerCase();
      if (p.includes("insta")) return "instagram";
      if (p.includes("tiktok")) return "tiktok";
      if (p.includes("you")) return "youtube";
      return p || "other";
    }

    function tagClass(p){
      const np = normPlatform(p);
      if (np === "youtube") return "youtube";
      if (np === "instagram") return "instagram";
      if (np === "tiktok") return "tiktok";
      return "";
    }

    function escapeHtml(s){
      return String(s || "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function render(){
      const q = (elSearch.value || "").trim().toLowerCase();

      const filtered = allAccounts
        .filter(a => activeFilter === "all" ? true : normPlatform(a.platform) === activeFilter)
        .filter(a => {
          if (!q) return true;
          const hay = `${a.name || ""} ${a.username || ""} ${a.platform || ""}`.toLowerCase();
          return hay.includes(q);
        });

      // Metrics
      const total = allAccounts.length;
      const insta = allAccounts.filter(a => normPlatform(a.platform)==="instagram").length;
      const tiktok = allAccounts.filter(a => normPlatform(a.platform)==="tiktok").length;
      const youtube = allAccounts.filter(a => normPlatform(a.platform)==="youtube").length;
      mTotal.textContent = total ? total : "—";
      mInsta.textContent = insta ? insta : "—";
      mTiktok.textContent = tiktok ? tiktok : "—";
      mYoutube.textContent = youtube ? youtube : "—";

      if (!filtered.length){
        elGrid.innerHTML = "";
        elEmpty.style.display = total ? "block" : "none";
        return;
      }
      elEmpty.style.display = "none";

      elGrid.innerHTML = filtered.map(acc => {
        const platform = normPlatform(acc.platform);
        const tCls = tagClass(platform);

        const name = escapeHtml(acc.name || acc.username || "Аккаунт");
        const username = (acc.username || "").trim();
        const id = escapeHtml(acc.account_id || acc.id || "");

        const isYt = platform === "youtube";
        const ytSaved = (isYt && id) ? getYtLink(id) : null;
        const url = ytSaved || acc.profile_url || null;
        const sUrl = acc.search_url || null;

        const linkHtml = url
          ? `<a class="linkbtn open" href="${escapeHtml(url)}" target="_blank" rel="noopener noreferrer">Открыть</a>`
          : (sUrl
              ? `<a class="linkbtn search" href="${escapeHtml(sUrl)}" target="_blank" rel="noopener noreferrer">Поиск</a>`
              : `<span class="linkbtn none">Нет ссылки</span>`
            );

        const ytEditBtn = isYt
          ? `<a class="linkbtn" href="#" data-yt-edit="${id}" data-yt-has="${url ? "1" : "0"}">${url ? "Изменить" : "Добавить"}</a>`
          : ``;

        const uBadge = username
          ? `<span class="badge">@${escapeHtml(username.replace(/^@/, ""))}</span>`
          : `<span class="badge">id: ${id || "—"}</span>`;

        return `
          <div class="card">
            <div class="tag ${tCls}">${platform.toUpperCase()}</div>
            <h3 class="name">${name}</h3>
            <div class="meta">
              ${uBadge}
              ${id ? `<span class="badge">account_id: ${id}</span>` : ``}
            </div>
            <div class="actions">
              ${linkHtml}
              ${ytEditBtn}
              <a class="linkbtn" href="#" data-copy="${escapeHtml(username || name)}">Копировать</a>
            </div>
          </div>
        `;
      }).join("");

      // Copy buttons
      elGrid.querySelectorAll("[data-copy]").forEach(btn => {
        btn.addEventListener("click", (e) => {
          e.preventDefault();
          const v = btn.getAttribute("data-copy") || "";
          navigator.clipboard.writeText(v).then(() => setStatus(true, "Скопировано")).catch(() => setStatus(false, "Не удалось скопировать"));
        });
      });
    }

    async function loadAccounts(){
      const key = (getSavedKey() || (elKey.value || "").trim()).trim();
      if (!key){
        setStatus(false, "Введите API‑ключ");
        return;
      }

      elKey.value = key;
      setStatus(null, "Загрузка…");
      elDebug.style.display = "none";
      elDebug.textContent = "";

      // show skeleton
      elGrid.innerHTML = Array.from({length: 6}).map(() => `
        <div class="card skeleton">
          <div style="height:14px; width:80px; border-radius:3px; background: var(--border);"></div>
          <div style="height:18px; width:70%; border-radius:3px; background: var(--border); margin-top:8px;"></div>
          <div style="height:12px; width:50%; border-radius:3px; background: var(--border); margin-top:6px;"></div>
          <div style="display:flex; gap:8px; margin-top:10px;">
            <div style="height:28px; width:80px; border-radius:3px; background: var(--border);"></div>
            <div style="height:28px; width:80px; border-radius:3px; background: var(--border);"></div>
          </div>
        </div>
      `).join("");

      try{
        const url = `${webhookUrl}?key=${encodeURIComponent(key)}`;
        const res = await fetch(url, { method:"GET" });

        const text = await res.text();
        if (!text){
          setStatus(false, "Пустой ответ от webhook");
          elDebug.style.display = "block";
          elDebug.textContent = "Пустой body. Проверь Respond to Webhook / response mode в n8n.";
          allAccounts = [];
          render();
          return;
        }

        let data;
        try{ data = JSON.parse(text); }
        catch(e){
          setStatus(false, "Ответ не JSON");
          elDebug.style.display = "block";
          elDebug.textContent = "Raw response:\n\n" + text;
          allAccounts = [];
          render();
          return;
        }

        if (!Array.isArray(data)){
          setStatus(false, "Ошибка ответа");
          elDebug.style.display = "block";
          elDebug.textContent = JSON.stringify(data, null, 2);
          allAccounts = [];
          render();
          return;
        }

        allAccounts = data.map(x => x && x.platform ? x : (x.json || x)).filter(Boolean);

        setStatus(true, "Данные загружены");
        render();
      }catch(e){
        setStatus(false, "ОШИБКА ЗАГРУЗКИ");
        elDebug.style.display = "block";
        elDebug.textContent = String(e && e.message ? e.message : e);
        allAccounts = [];
        render();
      }
    }

    // ====== Wire up UI ======
    document.getElementById("btnLoad").addEventListener("click", loadAccounts);
    document.getElementById("btnSave").addEventListener("click", saveKey);
    document.getElementById("btnLogout").addEventListener("click", logout);

    elSearch.addEventListener("input", render);

    document.querySelectorAll(".chip").forEach(chip => {
      chip.addEventListener("click", () => {
        document.querySelectorAll(".chip").forEach(c => c.classList.remove("active"));
        chip.classList.add("active");
        activeFilter = chip.getAttribute("data-filter") || "all";
        render();
      });
    });

    document.getElementById("copyWebhook").addEventListener("click", (e) => {
      e.preventDefault();
      navigator.clipboard.writeText(webhookUrl).then(() => setStatus(true, "Webhook скопирован")).catch(() => setStatus(false, "Не удалось скопировать"));
    });

    // ====== Auto-load ======
    (function init(){
      const saved = getSavedKey();
      if (saved){
        elKey.value = saved;
        loadAccounts();
      }else{
        setStatus(null, "System Ready");
      }
    })();
  </script>
</body>
</html>
